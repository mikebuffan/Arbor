-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.app_users (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT app_users_pkey PRIMARY KEY (id)
);
CREATE TABLE public.billing_customers (
  user_id uuid NOT NULL,
  stripe_customer_id text NOT NULL UNIQUE,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  subscription_status text NOT NULL DEFAULT 'inactive'::text CHECK (subscription_status = ANY (ARRAY['active'::text, 'trialing'::text, 'past_due'::text, 'canceled'::text, 'unpaid'::text, 'incomplete'::text, 'incomplete_expired'::text, 'paused'::text, 'inactive'::text])),
  price_id text,
  current_period_end timestamp with time zone,
  CONSTRAINT billing_customers_pkey PRIMARY KEY (user_id)
);
CREATE TABLE public.billing_subscriptions (
  user_id text NOT NULL,
  stripe_customer_id text NOT NULL,
  stripe_subscription_id text UNIQUE,
  status text NOT NULL,
  price_id text,
  current_period_end timestamp with time zone,
  cancel_at_period_end boolean NOT NULL DEFAULT false,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT billing_subscriptions_pkey PRIMARY KEY (user_id)
);
CREATE TABLE public.conversation_summaries (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  conversation_id uuid NOT NULL,
  summary jsonb NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT conversation_summaries_pkey PRIMARY KEY (id)
);
CREATE TABLE public.conversations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  project_id uuid NOT NULL,
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  title text,
  CONSTRAINT conversations_pkey PRIMARY KEY (id),
  CONSTRAINT conversations_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id)
);
CREATE TABLE public.memories (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  project_id uuid,
  conversation_id uuid,
  kind text NOT NULL,
  subject text,
  value jsonb NOT NULL,
  importance integer NOT NULL DEFAULT 5,
  sensitivity text NOT NULL DEFAULT 'normal'::text,
  confidence real NOT NULL DEFAULT 0.75,
  source text NOT NULL DEFAULT 'auto'::text,
  last_seen_at timestamp with time zone NOT NULL DEFAULT now(),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT memories_pkey PRIMARY KEY (id)
);
CREATE TABLE public.memory_items (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  project_id uuid,
  mem_key text NOT NULL,
  mem_value text NOT NULL,
  display_text text NOT NULL,
  trigger_terms ARRAY NOT NULL DEFAULT '{}'::text[],
  emotional_weight text NOT NULL DEFAULT 'neutral'::text CHECK (emotional_weight = ANY (ARRAY['light'::text, 'neutral'::text, 'heavy'::text])),
  relational_context ARRAY NOT NULL DEFAULT '{}'::text[],
  reveal_policy text NOT NULL DEFAULT 'normal'::text CHECK (reveal_policy = ANY (ARRAY['normal'::text, 'user_trigger_only'::text, 'never'::text])),
  strength numeric NOT NULL DEFAULT 1.0,
  last_reinforced_at timestamp with time zone NOT NULL DEFAULT now(),
  correction_count integer NOT NULL DEFAULT 0,
  is_locked boolean NOT NULL DEFAULT false,
  repair_flag boolean NOT NULL DEFAULT false,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  pinned boolean NOT NULL DEFAULT false,
  discarded_at timestamp with time zone,
  confirmed_at timestamp with time zone,
  key text,
  value jsonb,
  tier text DEFAULT 'normal'::text,
  user_trigger_only boolean DEFAULT false,
  importance integer DEFAULT 8,
  confidence numeric DEFAULT 0.95,
  locked boolean DEFAULT false,
  mention_count integer DEFAULT 1,
  last_seen_at timestamp with time zone DEFAULT now(),
  embedding USER-DEFINED,
  scope text DEFAULT 'conversation'::text CHECK (scope = ANY (ARRAY['global'::text, 'project'::text, 'conversation'::text])),
  CONSTRAINT memory_items_pkey PRIMARY KEY (id)
);
CREATE TABLE public.memory_pending (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  project_id uuid,
  question text DEFAULT ''::text,
  ops jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  memory_key text,
  event_type text,
  payload jsonb,
  CONSTRAINT memory_pending_pkey PRIMARY KEY (id)
);
CREATE TABLE public.messages (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  conversation_id uuid NOT NULL,
  user_id uuid NOT NULL,
  role text NOT NULL CHECK (role = ANY (ARRAY['user'::text, 'assistant'::text, 'system'::text])),
  content text NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  deleted_at timestamp with time zone,
  expires_at timestamp with time zone,
  project_id uuid NOT NULL,
  CONSTRAINT messages_pkey PRIMARY KEY (id),
  CONSTRAINT messages_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id)
);
CREATE TABLE public.projects (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  name text NOT NULL DEFAULT 'Default Project'::text,
  persona_id text NOT NULL DEFAULT 'arbor'::text,
  framework_version text NOT NULL DEFAULT 'v1'::text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  persona text DEFAULT 'default'::text,
  description text,
  CONSTRAINT projects_pkey PRIMARY KEY (id)
);
CREATE TABLE public.safety_signals (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  conversation_id uuid NOT NULL,
  distress_level integer NOT NULL,
  self_harm_signal boolean NOT NULL,
  crisis_signal boolean NOT NULL,
  intent_or_plan boolean NOT NULL,
  confidence double precision NOT NULL,
  reason_short text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT safety_signals_pkey PRIMARY KEY (id)
);
CREATE TABLE public.system_heartbeats (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  created_at timestamp with time zone DEFAULT now(),
  status text NOT NULL,
  processed_users integer DEFAULT 0,
  notes text,
  CONSTRAINT system_heartbeats_pkey PRIMARY KEY (id)
);
CREATE TABLE public.system_jobs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  type text NOT NULL,
  status text NOT NULL DEFAULT 'pending'::text,
  payload jsonb,
  created_at timestamp with time zone DEFAULT now(),
  started_at timestamp with time zone,
  completed_at timestamp with time zone,
  error_message text,
  retry_count integer DEFAULT 0,
  next_run_at timestamp with time zone,
  last_error text,
  CONSTRAINT system_jobs_pkey PRIMARY KEY (id)
);
CREATE TABLE public.system_locks (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL UNIQUE,
  locked_at timestamp with time zone DEFAULT now(),
  released_at timestamp with time zone,
  is_active boolean DEFAULT true,
  CONSTRAINT system_locks_pkey PRIMARY KEY (id)
);
CREATE TABLE public.usage_daily (
  user_id text NOT NULL,
  day date NOT NULL,
  turns integer NOT NULL DEFAULT 0,
  tokens_in integer NOT NULL DEFAULT 0,
  tokens_out integer NOT NULL DEFAULT 0,
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT usage_daily_pkey PRIMARY KEY (user_id, day)
);
CREATE TABLE public.user_memory_summaries (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  kind text NOT NULL DEFAULT 'session'::text CHECK (kind = ANY (ARRAY['session'::text, 'daily'::text, 'project'::text, 'note'::text])),
  summary text NOT NULL,
  tags ARRAY DEFAULT '{}'::text[],
  soothers ARRAY DEFAULT '{}'::text[],
  soft_triggers ARRAY DEFAULT '{}'::text[],
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_memory_summaries_pkey PRIMARY KEY (id),
  CONSTRAINT user_memory_summaries_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.user_prefs (
  user_id uuid NOT NULL,
  preferred_name text,
  language text DEFAULT 'auto'::text CHECK (language = ANY (ARRAY['auto'::text, 'en'::text, 'es'::text])),
  tone_preset text DEFAULT 'balanced'::text CHECK (tone_preset = ANY (ARRAY['gentle'::text, 'balanced'::text, 'direct'::text])),
  humor_level text DEFAULT 'medium'::text CHECK (humor_level = ANY (ARRAY['low'::text, 'medium'::text, 'spicy'::text])),
  challenge_default text DEFAULT 'off'::text CHECK (challenge_default = ANY (ARRAY['off'::text, 'on'::text])),
  likes_pop_culture boolean DEFAULT false,
  pop_culture_likes ARRAY DEFAULT '{}'::text[],
  pop_culture_dislikes ARRAY DEFAULT '{}'::text[],
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_prefs_pkey PRIMARY KEY (user_id),
  CONSTRAINT user_prefs_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.user_profile (
  user_id text NOT NULL,
  persona_variant text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT user_profile_pkey PRIMARY KEY (user_id)
);
CREATE TABLE public.user_working_context (
  user_id uuid NOT NULL,
  capacity_level smallint CHECK (capacity_level = ANY (ARRAY[10, 30, 60, 80])),
  today_context text,
  current_projects ARRAY DEFAULT '{}'::text[],
  current_stressors ARRAY DEFAULT '{}'::text[],
  last_seen_at timestamp with time zone DEFAULT now(),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_working_context_pkey PRIMARY KEY (user_id),
  CONSTRAINT user_working_context_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);